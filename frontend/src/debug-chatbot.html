<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ú†Øªâ€ŒØ¨Ø§Øª SSE</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        .chat-container { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
        .message { margin: 5px 0; padding: 5px; }
        .user { background: #e1f5fe; text-align: left; }
        .assistant { background: #f3e5f5; text-align: right; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Ú†Øªâ€ŒØ¨Ø§Øª SSE</h1>
    
    <div class="test-section">
        <h3>ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ API</h3>
        <button onclick="testConnection()">Ø§ØªØµØ§Ù„ Ø¨Ù‡ API</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="test-section">
        <h3>ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¹Ø§Ø¯ÛŒ</h3>
        <input type="text" id="testMessage" value="Ø³Ù„Ø§Ù…ØŒ Ø§ÛŒÙ† ÛŒÚ© ØªØ³Øª Ø§Ø³Øª" style="width: 300px; padding: 5px;">
        <button onclick="testSendMessage()">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…</button>
        <div id="message-result"></div>
    </div>
    
    <div class="test-section">
        <h3>ØªØ³Øª Streaming (Ø±ÙˆØ´ Ø¬Ø¯ÛŒØ¯)</h3>
        <input type="text" id="streamMessage" value="ØªØ³Øª Ø§Ø³ØªØ±ÛŒÙ…" style="width: 300px; padding: 5px;">
        <button onclick="testStreaming()">ØªØ³Øª Stream</button>
        <button onclick="stopStreaming()">ØªÙˆÙ‚Ù Stream</button>
        <div id="stream-result"></div>
        <div id="chat-container" class="chat-container"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api/v1/services/conversation_sse';
        let currentController = null;
        let conversationId = `conv_${Date.now()}`;
        
        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<div class="success">âœ… Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚: ${JSON.stringify(data)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${response.status}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        async function testSendMessage() {
            const resultDiv = document.getElementById('message-result');
            const message = document.getElementById('testMessage').value;

            try {
                const response = await fetch(`${API_URL}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conversationId
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">âœ… Ù¾Ø§Ø³Ø®: ${JSON.stringify(data)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        async function testStreaming() {
            const resultDiv = document.getElementById('stream-result');
            const chatContainer = document.getElementById('chat-container');
            const message = document.getElementById('streamMessage').value;

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬ Ù‚Ø¨Ù„ÛŒ
            resultDiv.innerHTML = '<div>ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª stream...</div>';
            chatContainer.innerHTML = '';

            // Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.textContent = message;
            chatContainer.appendChild(userMsg);

            // Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø® Ø¯Ø³ØªÛŒØ§Ø±
            const assistantMsg = document.createElement('div');
            assistantMsg.className = 'message assistant';
            assistantMsg.textContent = '';
            chatContainer.appendChild(assistantMsg);

            // Ø§ÛŒØ¬Ø§Ø¯ AbortController Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
            currentController = new AbortController();

            try {
                const response = await fetch(`${API_URL}/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conversationId
                    }),
                    signal: currentController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                resultDiv.innerHTML += '<div class="success">âœ… Stream Ø¨Ø§Ø² Ø´Ø¯</div>';

                // Ø®ÙˆØ§Ù†Ø¯Ù† stream Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        resultDiv.innerHTML += '<div>ğŸ Stream ØªÙ…Ø§Ù… Ø´Ø¯</div>';
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });

                    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®Ø·ÙˆØ· Ú©Ø§Ù…Ù„
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø¢Ø®Ø±ÛŒÙ† Ø®Ø· Ù†Ø§Ù‚Øµ

                    for (const line of lines) {
                        if (line.trim() === '') continue;

                        if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6);

                            try {
                                const data = JSON.parse(dataStr);

                                if (data.status === 'connected') {
                                    continue; // Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ù¾ÛŒØ§Ù… Ø§ØªØµØ§Ù„
                                }

                                if (data.status === 'done') {
                                    resultDiv.innerHTML += '<div>ğŸ Stream ØªÙ…Ø§Ù… Ø´Ø¯</div>';
                                    return;
                                }

                                if (data.error) {
                                    throw new Error(data.error);
                                }

                                if (data.content) {
                                    assistantMsg.textContent += data.content;
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                                resultDiv.innerHTML += `<div class="error">âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ¬Ø²ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡: ${e.message}</div>`;
                            }
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    resultDiv.innerHTML += '<div>â¹ï¸ Stream Ù…ØªÙˆÙ‚Ù Ø´Ø¯</div>';
                } else {
                    resultDiv.innerHTML += `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                }
            }
        }

        function stopStreaming() {
            if (currentController) {
                currentController.abort();
                currentController = null;
            }
        }
    </script>
</body>
</html>
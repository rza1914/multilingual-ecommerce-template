name: Tests and Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    name: Backend Tests (FastAPI)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8 black

    - name: Run Black (Code Formatting Check)
      working-directory: ./backend
      run: |
        black --check app/ || echo "::warning::Black formatting issues found"

    - name: Run Flake8 (Linting)
      working-directory: ./backend
      run: |
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run Tests with Coverage
      working-directory: ./backend
      run: |
        pytest --cov=app --cov-report=xml --cov-report=term-missing --cov-fail-under=70 || echo "::warning::Coverage below 70%"

    - name: Upload Backend Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false

  frontend-tests:
    name: Frontend Tests (React + TypeScript)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run ESLint (Linting)
      working-directory: ./frontend
      run: npm run lint

    - name: TypeScript Type Check
      working-directory: ./frontend
      run: npx tsc --noEmit

    - name: Run Tests with Coverage
      working-directory: ./frontend
      run: |
        npm test -- --coverage --watchAll=false || echo "::warning::Tests failed or coverage below 60%"

    - name: Upload Frontend Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./frontend/coverage/coverage-final.json
        flags: frontend
        name: frontend-coverage
        fail_ci_if_error: false

  build:
    name: Build Application
    needs: [backend-tests, frontend-tests]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build

    - name: Upload Frontend Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: ./frontend/dist
        retention-days: 7

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install Backend Dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify Backend Can Start
      working-directory: ./backend
      run: |
        python -c "from app.main import app; print('Backend imports successfully')"

  coverage-report:
    name: Generate Coverage Report
    needs: [backend-tests, frontend-tests]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Coverage Reports
      uses: actions/download-artifact@v4
      with:
        path: ./coverage-reports

    - name: Display Coverage Summary
      run: |
        echo "## Coverage Report Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Coverage reports generated for backend and frontend." >> $GITHUB_STEP_SUMMARY
        echo "- Backend: Required minimum 70%" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: Required minimum 60%" >> $GITHUB_STEP_SUMMARY
